# Copilot Instructions for kennethheine.com

This project is a modern Infrastructure as Code (IaC) implementation for deploying Azure Static Web Apps using Bicep templates and GitHub Actions.

## üìã Project Overview

**Project Type:** Azure Static Web App with Infrastructure as Code
**Tech Stack:** Bicep, GitHub Actions, HTML/CSS/JavaScript, PowerShell
**Deployment:** Azure Static Web Apps with federated identity authentication
**Author:** Kenneth S√∏lberg

## üèóÔ∏è Architecture & Structure

### Core Components
- **`infra/`** - Bicep Infrastructure as Code templates
- **`static-web-app/`** - Frontend application source code
- **`.github/workflows/`** - CI/CD pipeline definitions
- **`scripts/`** - PowerShell automation scripts for Azure setup

### Key Technologies
- **Azure Static Web Apps** - Primary hosting platform
- **Bicep** - Infrastructure as Code language
- **GitHub Actions** - CI/CD automation
- **OIDC/Federated Identity** - Secure authentication without secrets
- **PowerShell** - Azure configuration automation

## üéØ Code Generation Guidelines

### Infrastructure (Bicep)
- Always use the latest API versions (check Azure documentation)
- Follow the existing naming convention: `{resourceType}-{projectName}-{environment}`
- Use resource tokens for unique naming: `uniqueString(subscription().subscriptionId, resourceGroup().id)`
- Include comprehensive parameter descriptions with `@description()` decorators
- Apply consistent tagging strategy with project, environment, and managedBy tags
- Use modular approach - create reusable modules in `infra/modules/`
- Enable Bicep analyzer rules for security and best practices

### GitHub Actions Workflows
- Use federated identity (OIDC) for Azure authentication - never store secrets
- Include comprehensive what-if analysis before deployments
- Add detailed logging with emojis for better readability (üîç, ‚úÖ, ‚ùå, üöÄ, etc.)
- Implement proper error handling and validation steps
- Create detailed GitHub step summaries with status information
- Use environment protection for production deployments

### PowerShell Scripts
- Follow PowerShell best practices with proper error handling
- Use meaningful variable names and comments
- Include verbose output for troubleshooting
- Implement retry logic for transient Azure failures
- Use approved PowerShell verbs (Get-, Set-, New-, Remove-)

### Frontend Development
- Keep it simple and modern - this is a personal website
- Use semantic HTML5 structure
- Implement responsive CSS design
- Follow accessibility best practices
- Minimize dependencies - prefer vanilla JavaScript when possible

## üöÄ Deployment Philosophy

### GitHub Actions Only Policy
This project follows a **strict CI/CD approach** where ALL deployments (infrastructure and frontend) must go through GitHub Actions. This ensures:

- **Security**: All deployments use federated identity (OIDC) without exposing secrets
- **Audit Trail**: Complete history of all changes and deployments
- **Consistency**: Same deployment process every time
- **Quality Gates**: Automated validation, testing, and approval workflows
- **Rollback Capability**: Easy to revert changes through Git history

### Local Development vs. Deployment
- **Local Development**: Used for fast feedback and validation
  - ‚úÖ `npm run dev` - Next.js development server
  - ‚úÖ `npm test` - Run unit tests
  - ‚úÖ `npm run build` - Test build process
  - ‚úÖ `az deployment group what-if` - Preview infrastructure changes
  - ‚úÖ `az deployment group validate` - Validate Bicep templates
  - ‚úÖ `bicep build` - Compile and validate Bicep syntax
- **Deployment**: Always through GitHub Actions (merge to main, PR previews)
  - ‚ùå Never run `azd up`, `az deployment group create`, or similar deployment commands locally

### Deployment Triggers
- **Infrastructure**: Triggered by changes to `infra/` folder when merged to main
- **Frontend**: Triggered by changes to `static-web-app/` folder when merged to main
- **Preview**: Triggered by pull requests for preview environments

## üíª Development and Deployment Policy

### Local Testing and Validation (‚úÖ ENCOURAGED)
Fast feedback loop for development:
- **Local testing**: `cd static-web-app && npm run dev` (Next.js dev server)
- **Build validation**: `cd static-web-app && npm run build` (check for build errors)
- **Infrastructure validation**: `az deployment group what-if` (preview changes)
- **Code analysis**: ESLint, TypeScript checks, etc.
- **Local preview**: Test built static files locally before pushing

### Deployment Policy (‚ö†Ô∏è STRICT)
ALL deployments must go through GitHub Actions:
- **Frontend deployments**: Triggered automatically on push to main or PR creation
- **Infrastructure deployments**: Triggered through GitHub Actions workflow
- **No local deployments**: Never run deployment commands locally
- **CI/CD only**: All production changes must go through the pipeline

## üîß Development Practices

### File Naming & Organization
- Use kebab-case for file names
- Organize Bicep templates in logical modules
- Keep parameters in separate `.bicepparam` files
- Use descriptive names that indicate purpose

### Security Best Practices
- Never expose secrets in Bicep outputs
- Use managed identities where possible
- Implement least-privilege access
- Enable diagnostic settings for monitoring
- Use secure parameter types (`@secure()`) for sensitive data

### Testing & Validation
- **Run locally for fast feedback**: Bicep what-if analysis, template validation, frontend testing
- **Use GitHub Actions for actual deployments**: All infrastructure and frontend deployments
- Test workflows in feature branches before merging
- Include comprehensive error handling

### Local Testing Commands
- `az deployment group what-if` - Preview infrastructure changes before committing
- `az deployment group validate` - Validate Bicep templates syntax and logic
- `bicep build main.bicep` - Compile and check Bicep syntax
- `npm run dev` - Start Next.js development server
- `npm test` - Run unit tests and check code quality
- `npm run build` - Test the build process locally

## üö® Important Rules

### Never Do
- ‚ùå Store secrets in GitHub repository or workflows
- ‚ùå Use hardcoded values - always parameterize
- ‚ùå Skip what-if analysis for infrastructure changes
- ‚ùå Deploy directly to production without validation
- ‚ùå Remove security and monitoring configurations
- ‚ùå **Deploy infrastructure or frontend code locally** - ALL deployments must go through GitHub Actions
- ‚ùå Run `azd up`, `az deployment group create`, or similar deployment commands locally
- ‚ùå Bypass CI/CD pipeline for any production changes

### Always Do
- ‚úÖ Use federated identity for Azure authentication
- ‚úÖ Include comprehensive logging and status reporting
- ‚úÖ Follow Infrastructure as Code principles
- ‚úÖ Test changes in feature branches first
- ‚úÖ Document infrastructure decisions and configurations
- ‚úÖ Use consistent naming conventions
- ‚úÖ Implement proper error handling
- ‚úÖ **Deploy ONLY through GitHub Actions** - never deploy locally
- ‚úÖ **Run validation and testing locally for fast feedback** (`what-if`, `npm test`, `npm run dev`)
- ‚úÖ Let CI/CD handle all production deployments with proper approvals

## üîÑ Workflow Patterns

### Infrastructure Changes
1. Create feature branch
2. Modify Bicep templates or parameters
3. Push changes to trigger what-if analysis
4. Review what-if output in PR
5. **Merge to main for automatic deployment via GitHub Actions**
6. **NEVER deploy infrastructure changes locally**

### Frontend Updates
1. Modify files in `static-web-app/`
2. Test locally using Next.js development server: `npm run dev`
3. Push to feature branch for preview deployment (PR)
4. Review preview environment
5. **Merge to main for production deployment via GitHub Actions**
6. **NEVER deploy frontend changes locally**

### Frontend Deployment Workflow
- **Validation Job**: Validates code structure, dependencies, and configuration
- **Preview Job**: Creates preview environment for PRs with automatic cleanup
- **Deploy Job**: Deploys to production on main branch merge
- **Token Management**: Securely retrieves deployment tokens using OIDC
- **Verification**: Confirms deployment success and provides access URLs

## üí° Common Tasks

### Adding New Azure Resources
1. Create or update Bicep module in `infra/modules/`
2. Reference module in `main.bicep`
3. Add parameters to `production.bicepparam`
4. **Test locally with what-if analysis for fast feedback** (`az deployment group what-if`)
5. **Validate template syntax** (`az deployment group validate`)
6. **Deploy via GitHub Actions by merging to main branch**

### Updating Frontend Content
1. Modify files in `static-web-app/` (Next.js components, pages, styles, assets)
2. **Test locally for fast feedback**: `npm run dev`, `npm test`, `npm run build`
3. Push changes to trigger validation and **automatic deployment via GitHub Actions**
4. Review deployment summary and verify live site
5. **Never use manual deployment commands locally**

### Updating Deployment Configuration
1. Modify workflow files in `.github/workflows/`
2. Test in feature branch
3. Review execution logs carefully

### Environment Configuration
- Production parameters: `infra/parameters/production.bicepparam`
- GitHub secrets configured via PowerShell scripts in `scripts/`
- Resource naming follows: `{type}-kennethheine-{env}` pattern

## üé® Style Preferences

- Use emojis in logging for better visual scanning
- Prefer descriptive variable names over abbreviations
- Include comprehensive comments for complex logic
- Use consistent indentation (2 spaces for YAML, 4 for PowerShell)
- Group related configurations together

## üîç Debugging & Troubleshooting

- Check GitHub Actions logs for deployment issues
- Use Azure CLI what-if for infrastructure validation
- Review Bicep analyzer warnings and errors
- Verify OIDC configuration if authentication fails
- Check resource group permissions for deployment failures

Remember: This is a production website deployment system. Prioritize security, reliability, and maintainability in all code generation and modifications.
